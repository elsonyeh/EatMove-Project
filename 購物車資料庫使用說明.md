# 🛒 購物車資料庫系統使用說明

## 📋 系統概述

您的 EatMove 外送平台已經完整實現了購物車資料庫系統！這個系統可以將用戶的購物車資料永久保存在 PostgreSQL 資料庫中，支援跨設備同步和完整的購物車管理功能。

## 🚀 快速開始

### 1. 啟動開發伺服器

```bash
npm run dev
```

### 2. 初始化資料庫表格

訪問以下 URL 來創建購物車相關表格：

```
http://localhost:3000/api/db-setup
```

### 3. 檢查表格狀態

```
http://localhost:3000/api/check-tables
```

## 🎯 主要功能

### 📊 資料庫表格

1. **`cart` 表格**：購物車主表

   - 每個用戶在每個餐廳只能有一個購物車
   - 自動記錄創建和更新時間

2. **`cart_items` 表格**：購物車項目表
   - 支援數量調整和特殊要求
   - 自動級聯刪除

### 🔧 API 端點

#### 購物車管理 (`/api/cart`)

- **GET**: 獲取購物車內容
- **POST**: 添加商品到購物車
- **DELETE**: 清空購物車

#### 購物車項目管理 (`/api/cart/[cart_item_id]`)

- **PUT**: 更新項目數量或特殊要求
- **DELETE**: 刪除單個購物車項目

### 🎨 前端組件

使用 `CartDB` 組件來實現購物車功能：

```tsx
import CartDB, { CartRef } from "@/components/cart-db";

const RestaurantPage = () => {
  const cartRef = useRef<CartRef>(null);

  const handleAddToCart = (item) => {
    cartRef.current?.addToCart({
      mid: item.mid,
      name: item.name,
      price: item.price,
      image: item.image,
      specialInstructions: "不要辣",
    });
  };

  return (
    <div>
      {/* 餐廳菜單內容 */}

      <CartDB
        ref={cartRef}
        restaurantId={restaurantId}
        restaurantName={restaurantName}
        minOrder={300}
        deliveryFee={50}
        onOrderSuccess={() => console.log("訂單成功")}
      />
    </div>
  );
};
```

## 📝 使用範例

### 1. 添加商品到購物車

```javascript
const response = await fetch("/api/cart", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    uid: 1, // 用戶ID
    rid: 5, // 餐廳ID
    mid: 10, // 菜單項目ID
    quantity: 2, // 數量
    specialInstructions: "不要辣", // 特殊要求
  }),
});
```

### 2. 獲取購物車內容

```javascript
const response = await fetch("/api/cart?uid=1&rid=5");
const result = await response.json();

console.log("購物車內容:", result.cart);
// 輸出：
// {
//   cart_id: 1,
//   items: [...],
//   total: 300,
//   itemCount: 2
// }
```

### 3. 更新購物車項目

```javascript
const response = await fetch("/api/cart/123", {
  method: "PUT",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    quantity: 3,
    specialInstructions: "加辣",
  }),
});
```

## 🔄 資料流程

1. **添加商品**：檢查購物車是否存在 → 創建或更新項目 → 更新時間戳
2. **修改數量**：直接更新項目 → 更新購物車時間戳
3. **刪除項目**：刪除項目 → 檢查是否為空 → 可能刪除整個購物車
4. **提交訂單**：創建訂單 → 清空購物車 → 跳轉確認頁面

## 🆚 與 localStorage 比較

| 特點       | localStorage | 資料庫   |
| ---------- | ------------ | -------- |
| 響應速度   | 極快         | 快       |
| 跨設備同步 | ❌           | ✅       |
| 資料持久性 | 易丟失       | 永久保存 |
| 離線使用   | ✅           | ❌       |
| 資料分析   | ❌           | ✅       |

## 🔧 維護建議

1. **定期清理**：清理超過 30 天未更新的購物車
2. **監控效能**：監控 API 響應時間
3. **備份策略**：定期備份購物車資料
4. **快取策略**：考慮使用 Redis 快取熱門商品

## 🚨 注意事項

1. **用戶認證**：目前使用 localStorage 存儲用戶 ID，生產環境需要完整認證系統
2. **併發處理**：多設備同時操作的併發控制
3. **資料一致性**：確保購物車中的商品價格與菜單價格一致
4. **容錯處理**：網路異常時的降級策略

## 🎉 系統優勢

✅ **完整實現**：資料庫表格、API 端點、前端組件全部完成
✅ **即時同步**：跨設備購物車同步
✅ **資料安全**：永久保存在資料庫中
✅ **用戶體驗**：流暢的購物車操作體驗
✅ **可擴展性**：支援未來功能擴展

您的購物車資料庫系統已經完全準備就緒！🚀
