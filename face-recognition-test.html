<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人臉辨識測試工具</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
        }

        .video-container {
            flex: 1;
        }

        .info-container {
            flex: 1;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }

        video {
            width: 100%;
            max-width: 640px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .video-wrapper {
            position: relative;
            display: inline-block;
        }

        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #e9ecef;
        }
    </style>
</head>

<body>
    <h1>人臉辨識測試工具</h1>
    <p>此工具用於診斷 face-api.js 的檢測結果結構問題</p>

    <div class="container">
        <div class="video-container">
            <div class="video-wrapper">
                <video id="video" autoplay muted playsinline></video>
                <canvas id="canvas"></canvas>
            </div>
            <div>
                <button onclick="startCamera()">開啟攝影機</button>
                <button onclick="stopCamera()">關閉攝影機</button>
                <button onclick="clearLog()">清除日誌</button>
            </div>
        </div>

        <div class="info-container">
            <h3>檢測狀態</h3>
            <div id="status" class="status">等待開始...</div>

            <h3>檢測日誌</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let video, canvas, ctx;
        let stream = null;
        let modelsLoaded = false;
        let detecting = false;

        async function loadModels() {
            const MODEL_URL = '/models';
            try {
                log('開始載入模型...');
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                ]);
                modelsLoaded = true;
                log('✓ 模型載入完成');
                updateStatus('模型已載入，可以開始測試');
            } catch (error) {
                log('✗ 模型載入失敗: ' + error.message);
                updateStatus('模型載入失敗');
            }
        }

        async function startCamera() {
            if (!modelsLoaded) {
                alert('請等待模型載入完成');
                return;
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480, facingMode: 'user' }
                });

                video.srcObject = stream;
                await video.play();

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                log('✓ 攝影機啟動成功');
                updateStatus('攝影機運行中，開始檢測...');

                detecting = true;
                detectFaces();
            } catch (error) {
                log('✗ 攝影機啟動失敗: ' + error.message);
                updateStatus('攝影機啟動失敗');
            }
        }

        function stopCamera() {
            detecting = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.srcObject = null;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            log('攝影機已關閉');
            updateStatus('攝影機已關閉');
        }

        async function detectFaces() {
            if (!detecting || !video.videoWidth) {
                if (detecting) {
                    requestAnimationFrame(detectFaces);
                }
                return;
            }

            try {
                const detections = await faceapi.detectAllFaces(
                    video,
                    new faceapi.TinyFaceDetectorOptions({
                        inputSize: 416,
                        scoreThreshold: 0.3
                    })
                ).withFaceLandmarks().withFaceDescriptors();

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (detections.length > 0) {
                    const detection = detections[0];

                    // 詳細分析檢測結果結構
                    log('=== 檢測結果分析 ===');
                    log('檢測到人臉數量: ' + detections.length);
                    log('檢測物件屬性: ' + Object.keys(detection).join(', '));

                    // 檢查各種可能的 box 屬性
                    let box = null;
                    if (detection.box) {
                        box = detection.box;
                        log('✓ detection.box 存在: ' + JSON.stringify(box));
                    } else if (detection.detection && detection.detection.box) {
                        box = detection.detection.box;
                        log('✓ detection.detection.box 存在: ' + JSON.stringify(box));
                    } else if (detection.detection && detection.detection._box) {
                        box = detection.detection._box;
                        log('✓ detection.detection._box 存在: ' + JSON.stringify(box));
                    } else if (detection._box) {
                        box = detection._box;
                        log('✓ detection._box 存在: ' + JSON.stringify(box));
                    } else {
                        log('✗ 找不到 box 屬性');

                        // 嘗試從 landmarks 計算
                        if (detection.landmarks && detection.landmarks.positions) {
                            const positions = detection.landmarks.positions;
                            const xs = positions.map(p => p.x);
                            const ys = positions.map(p => p.y);
                            const minX = Math.min(...xs);
                            const maxX = Math.max(...xs);
                            const minY = Math.min(...ys);
                            const maxY = Math.max(...ys);

                            box = {
                                x: Math.max(0, minX - 20),
                                y: Math.max(0, minY - 20),
                                width: maxX - minX + 40,
                                height: maxY - minY + 40
                            };
                            log('✓ 從 landmarks 計算邊界框: ' + JSON.stringify(box));
                        }
                    }

                    // 檢查其他屬性
                    log('landmarks 存在: ' + (detection.landmarks ? '是' : '否'));
                    log('descriptor 存在: ' + (detection.descriptor ? '是，長度: ' + detection.descriptor.length : '否'));

                    if (detection.detection) {
                        log('detection.detection 屬性: ' + Object.keys(detection.detection).join(', '));
                    }

                    // 繪製邊界框
                    if (box) {
                        ctx.strokeStyle = '#00ff00';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);
                        updateStatus(`檢測到人臉 - 位置: (${Math.round(box.x)}, ${Math.round(box.y)}) 大小: ${Math.round(box.width)}x${Math.round(box.height)}`);
                    } else {
                        updateStatus('檢測到人臉但無法取得位置資訊');
                    }

                    // 繪製特徵點
                    if (detection.landmarks) {
                        ctx.fillStyle = '#ff0000';
                        detection.landmarks.positions.forEach(point => {
                            ctx.fillRect(point.x - 1, point.y - 1, 2, 2);
                        });
                    }
                } else {
                    updateStatus('未檢測到人臉');
                }

            } catch (error) {
                log('檢測錯誤: ' + error.message);
                updateStatus('檢測過程發生錯誤');
            }

            if (detecting) {
                requestAnimationFrame(detectFaces);
            }
        }

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 初始化
        window.onload = function () {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            loadModels();
        };
    </script>
</body>

</html>